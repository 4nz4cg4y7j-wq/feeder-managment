<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Feeder Dashboard</title>

<style>
:root {
  --bg:#0f172a;
  --card:#111827;
  --accent:#22c55e;
  --muted:#64748b;
  --text:#e5e7eb;
}

* { box-sizing:border-box; }

body {
  margin:0;
  font-family:system-ui, sans-serif;
  background:var(--bg);
  color:var(--text);
}

header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px 25px;
  background:#020617;
}

header h1 { margin:0;font-size:20px; }

header button {
  background:#ef4444;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  color:white;
  cursor:pointer;
}

nav {
  display:flex;
  gap:20px;
  padding:10px 25px;
  border-bottom:1px solid #1e293b;
}

nav button {
  background:none;
  border:none;
  color:var(--muted);
  font-size:15px;
  cursor:pointer;
}

nav button.active {
  color:var(--accent);
  border-bottom:2px solid var(--accent);
}

main { padding:25px; }

.section { display:none; }
.section.active { display:block; }

.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:20px;
}

.card {
  background:var(--card);
  padding:18px;
  border-radius:12px;
  box-shadow:0 10px 25px rgba(0,0,0,.25);
}

.card h4 {
  margin:0 0 10px;
  outline:none;
  cursor:text;
}

button.primary {
  background:var(--accent);
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}

button.muted {
  background:#1e293b;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  color:var(--text);
  cursor:pointer;
}

button.success {
  background:#16a34a;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}

input, select {
  width:100%;
  padding:8px;
  margin:6px 0;
  background:#020617;
  border:1px solid #1e293b;
  border-radius:6px;
  color:var(--text);
}

.log {
  background:#020617;
  padding:10px;
  border-radius:6px;
  margin-bottom:8px;
  font-size:14px;
}
</style>
</head>

<body>

<header>
  <h1>Feeder Dashboard</h1>
  <button id="logoutBtn">Logout</button>
</header>

<nav>
  <button class="active" onclick="switchTab('feeders')">My Feeders</button>
  <button onclick="switchTab('addUnit')">Add Unit</button>
  <button onclick="switchTab('logs')">Feeder Log</button>
</nav>

<main>

<!-- MY FEEDERS -->
<section id="feeders" class="section active">
  <div class="grid" id="feedersGrid"></div>
</section>

<!-- ADD UNIT -->
<section id="addUnit" class="section">
  <div class="card" style="max-width:400px">
    <h3>Add Feeder Unit</h3>
    <input id="unitSerial" placeholder="Unit Serial Number">
    <input id="unitName" placeholder="Feeder Name">
    <button class="primary" onclick="addUnit()">Add Unit</button>
    <p id="addUnitMsg"></p>
  </div>
</section>

<!-- LOGS -->
<section id="logs" class="section">
  <div id="logContainer"></div>
</section>

</main>

<script>
/* ---------- Tabs ---------- */
function switchTab(id){
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(id).classList.add('active');
  if(id==='logs') loadLogs();
}

/* ---------- Feeders ---------- */
async function loadFeeders(){
  const res = await fetch('/api/myFeeders',{credentials:'include'});
  const feeders = await res.json();
  const grid = document.getElementById('feedersGrid');
  grid.innerHTML='';

  feeders.forEach(f=>{
    grid.innerHTML += `
    <div class="card">
      <h4 contenteditable="true"
          onblur="renameFeeder(${f.id},this.innerText)">
        ${f.feeder_name}
      </h4>

      <p>Status: ${f.sim_status}</p>

      <button class="primary" onclick="feedNow(${f.id})">Feed Now</button>
      <button class="muted" onclick="toggleSchedule(${f.id})">Schedule</button>

      <div id="schedule-${f.id}" style="display:none;margin-top:10px">
        <input type="time" id="time-${f.id}">
        <select id="days-${f.id}" multiple>
          <option>Mon</option><option>Tue</option><option>Wed</option>
          <option>Thu</option><option>Fri</option><option>Sat</option><option>Sun</option>
        </select>
        <button class="success" onclick="saveSchedule(${f.id})">Save Schedule</button>
      </div>
    </div>`;
  });
}

/* ---------- Actions ---------- */
async function feedNow(id){
  await fetch('/api/feedNow',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({unit_id:id})
  });
  alert('Feed triggered');
}

function toggleSchedule(id){
  const el=document.getElementById(`schedule-${id}`);
  el.style.display=el.style.display==='none'?'block':'none';
}

async function saveSchedule(id){
  const time=document.getElementById(`time-${id}`).value;
  const days=[...document.getElementById(`days-${id}`).selectedOptions].map(o=>o.value);
  await fetch('/api/saveSchedule',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({unit_id:id,feed_time:time,days:days.join(',')})
  });
  alert('Schedule saved');
}

async function renameFeeder(id,name){
  await fetch('/api/renameFeeder',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({unit_id:id,name})
  });
}

/* ---------- Add Unit ---------- */
async function addUnit(){
  const serial=document.getElementById('unitSerial').value;
  const name=document.getElementById('unitName').value;
  const res=await fetch('/api/addUnit',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify({serial,name})
  });
  document.getElementById('addUnitMsg').innerText =
    res.ok?'Unit added':'Error adding unit';
  loadFeeders();
}

/* ---------- Logs ---------- */
async function loadLogs(){
  const res=await fetch('/api/feederLogs',{credentials:'include'});
  const logs=await res.json();
  const c=document.getElementById('logContainer');
  c.innerHTML='';
  logs.forEach(l=>{
    c.innerHTML+=`
    <div class="log">
      <strong>${l.feeder_name}</strong><br>
      ${l.action} â€” ${l.timestamp}
    </div>`;
  });
}

/* ---------- Logout ---------- */
document.getElementById('logoutBtn').onclick=async()=>{
  await fetch('/api/logout',{method:'POST',credentials:'include'});
  window.location='/index.html';
};

loadFeeders();
</script>

</body>
</html>
